# EXPECT_RUNTIME_EXIT: 0
# EXPECT_STDOUT_CONTAINS: PASS: TooShort error preserved
# EXPECT_STDOUT_CONTAINS: PASS: TooLong error preserved
# EXPECT_STDOUT_CONTAINS: PASS: InvalidFormat error preserved
# EXPECT_STDERR_EMPTY: true

# Tests that error propagation preserves error data

enum ValidationError:
    TooShort
    TooLong
    InvalidFormat

fn validate_length(string s) bool | ValidationError:
    if (s == "a"):
        return Result.Err(ValidationError.TooShort)
    if (s == "verylongstring"):
        return Result.Err(ValidationError.TooLong)
    return Result.Ok(true)

fn validate_format(string s) bool | ValidationError:
    if (s == "###"):
        return Result.Err(ValidationError.InvalidFormat)
    return Result.Ok(true)

fn full_validation(string s) i32 | ValidationError:
    let bool len_ok = validate_length(s)??
    let bool fmt_ok = validate_format(s)??
    println("{len_ok}, {fmt_ok}")
    return Result.Ok(100)

fn main() i32:
    match full_validation("a"):
        Result.Ok(_) ->
            println("FAIL: Should have gotten TooShort")
            return Result.Ok(1)
        Result.Err(ValidationError.TooShort) ->
            println("PASS: TooShort error preserved")
        Result.Err(_) ->
            println("FAIL: Wrong error variant")
            return Result.Ok(1)

    match full_validation("verylongstring"):
        Result.Ok(_) ->
            println("FAIL: Should have gotten TooLong")
            return Result.Ok(1)
        Result.Err(ValidationError.TooLong) ->
            println("PASS: TooLong error preserved")
        Result.Err(_) ->
            println("FAIL: Wrong error variant")
            return Result.Ok(1)

    match full_validation("###"):
        Result.Ok(_) ->
            println("FAIL: Should have gotten InvalidFormat")
            return Result.Ok(1)
        Result.Err(ValidationError.InvalidFormat) ->
            println("PASS: InvalidFormat error preserved")
        Result.Err(_) ->
            println("FAIL: Wrong error variant")
            return Result.Ok(1)

    return Result.Ok(0)
